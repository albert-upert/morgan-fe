#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

set -e

pnpm lint

# Only check formatting for files changed on this branch vs upstream (or origin/main).
UPSTREAM="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo origin/main)"

CHANGED_FILES="$(git diff --name-only --diff-filter=ACMR "$UPSTREAM"...HEAD | tr '\n' ' ')"

if [ -z "$CHANGED_FILES" ]; then
  echo "pre-push: no changed files, skipping prettier check"
  exit 0
fi

# Limit to file types Prettier should handle
FILES_TO_CHECK="$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep -E '\.(js|jsx|ts|tsx|json|css|md|yml|yaml)$' || true)"

if [ -z "$FILES_TO_CHECK" ]; then
  echo "pre-push: no prettier-supported files changed, skipping prettier check"
  exit 0
fi

echo "$FILES_TO_CHECK" | xargs pnpm exec prettier --check
